name: ðŸš€ Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

    - name: Add EC2 to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

    - name: SSH and deploy
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          
          cd ~/user_service
          
          echo "ðŸ”„ Pulling latest code..."
          git pull origin main
          
          echo "ðŸ“¦ Installing dependencies..."
          npm install
          
          echo "âš™ï¸ Building project..."
          npm run build
          echo "âœ… Build complete."
          
          echo "ðŸ”§ Setting Redis environment variables..."
          export REDIS_HOST=${{ secrets.REDIS_HOST }}
          export REDIS_PORT=${{ secrets.REDIS_PORT }}
          export REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          
          echo "ðŸ”§ Setting PocketBase environment variables..."
          export POCKETBASE_ADMIN_EMAIL=${{ secrets.POCKETBASE_ADMIN_EMAIL }}
          export POCKETBASE_ADMIN_PASSWORD=${{ secrets.POCKETBASE_ADMIN_PASSWORD }}
          export POCKETBASE_URL=${{ secrets.POCKETBASE_URL }}
          export PORT=${{ secrets.PORT }}
          
          echo "ðŸš€ Restarting with PM2..."
          pm2 restart user-service || pm2 start dist/main.js --name user-service
          echo "âœ… PM2 process started/restarted."
          
          echo "ðŸ“œ Showing last 50 lines of PM2 logs:"
          pm2 logs user-service --lines 50 --nostream
        EOF
